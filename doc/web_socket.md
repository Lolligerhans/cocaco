# WebSocket

`WebSocket`s implement the WebSocket [protocol][RFC6455]. They are a lean way
for live data transfer between client and server. Host websites may send data
for every click or action, and receive updates to the game state from the
server.

## Hook

Clients use the `WebSocket` JavaScript constructor to instantiate WebSocket
connections. We inject JavaScript into the `"MAIN"` [world][WORLD] at
`"document_start"` to decorate the WebSocket interface. Our decoration then
communicates all invocations to content-scripts.

We use "frame" to refer to data native to WebSocket level, both in native and
deserialized encodings.

## WebSocket interactions

### Observe traffic

Observed frames are accessed through the `Reparse` module. This applies for
communication in both directions. Any other module must register a "reparser" to
obtain access to the data. On every newly observed frame, `Reparse` will invoke
all active reparsers in order of registration.

Reparsers are registered with a callback. The callback function implements the
user's logic.

### Generate traffic

New frames are generated by instantiating the `Resend` module. Resend implements
an interface to send messages to the host server. The implementation includes
registering reparsers to obtain the `sequence` number and `serverId` required
for correct formatting.

After injecting our own frames into the client→server connection we adjust later
sequence numbers to remain consistent. This prevents the automatic reload that
would otherwise be triggered by the next frame (with then-invalid sequence
number).

### Frame queue

Frames we generated in the current event cycle are sent only in the next event
cycle. This ensures that we wait for all host frames in the current event cycle,
preventing invalid sequence numbers.

The `FrameQueue` `outgoing` buffers frames for this purpose.

<!--
 !  ╭─────────────────────────────────────────────────────────╮
 !  │ Links                                                   │
 !  ╰─────────────────────────────────────────────────────────╯
-->

[RFC6455]: https://www.rfc-editor.org/rfc/rfc6455.html#section-5 "RFC: The WebSocket Protocol"
[WORLD]: https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_scripts "MDN Web Docs: content scripts"
